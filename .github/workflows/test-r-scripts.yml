name: R Script Tests

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**/*.R'
      - 'tests/**'
      - '.github/workflows/test-r-scripts.yml'
  pull_request:
    branches:
      - '**'
    paths:
      - 'scripts/**/*.R'
      - 'tests/**'
      - '.github/workflows/test-r-scripts.yml'
  workflow_dispatch:

jobs:
  test-r-scripts:
    runs-on: ubuntu-latest
    name: Run R Unit Tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.1'

      - name: Query R package dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          extra-packages: |
            any::testthat
            any::yaml
            any::data.table
            any::dplyr
            any::tidyr
            any::readr
            any::ggplot2
            any::gridExtra
            any::matrixStats
            any::optparse
            any::jsonlite
            any::logging

      - name: Display R version and packages
        run: |
          R --version
          Rscript -e "installed.packages()[, c('Package', 'Version')]"

      - name: Run testthat tests
        run: |
          Rscript -e "
          library(testthat)
          results <- test_dir('tests/testthat', reporter = 'progress')
          if (any(as.data.frame(results)[['failed']] > 0)) {
            quit(status = 1)
          }
          "

      - name: Test summary
        if: always()
        run: |
          echo "### R Script Tests Summary :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**R Version:** 4.4.1" >> $GITHUB_STEP_SUMMARY
          echo "**Test Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tested Components:**" >> $GITHUB_STEP_SUMMARY
          echo "- Config parsing" >> $GITHUB_STEP_SUMMARY
          echo "- Input validation logic" >> $GITHUB_STEP_SUMMARY
          echo "- Trait extraction logic" >> $GITHUB_STEP_SUMMARY
