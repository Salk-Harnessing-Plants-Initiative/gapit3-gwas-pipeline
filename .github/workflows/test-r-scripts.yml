name: R Script Tests

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**/*.R'
      - 'tests/**'
      - '.github/workflows/test-r-scripts.yml'
  pull_request:
    branches:
      - '**'
    paths:
      - 'scripts/**/*.R'
      - 'tests/**'
      - '.github/workflows/test-r-scripts.yml'
  workflow_dispatch:

jobs:
  test-r-scripts:
    runs-on: ubuntu-latest
    name: Run R Unit Tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.1'
          use-public-rspm: true

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-4.4.1-${{ hashFiles('.github/R-version') }}
          restore-keys: |
            ${{ runner.os }}-r-4.4.1-

      - name: Install R package dependencies
        run: |
          install.packages(c(
            'testthat',
            'yaml',
            'data.table',
            'dplyr',
            'tidyr',
            'readr',
            'ggplot2',
            'gridExtra',
            'matrixStats',
            'optparse',
            'jsonlite',
            'logging'
          ), repos = 'https://cloud.r-project.org', Ncpus = 2)
        shell: Rscript {0}

      - name: Display R version and packages
        run: |
          R --version
          Rscript -e "installed.packages()[, c('Package', 'Version')]"

      - name: Run testthat tests
        run: |
          Rscript -e "
          library(testthat)
          results <- test_dir('tests/testthat', reporter = 'progress')
          if (any(as.data.frame(results)[['failed']] > 0)) {
            quit(status = 1)
          }
          "

      - name: Test summary
        if: always()
        run: |
          echo "### R Script Tests Summary :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**R Version:** 4.4.1" >> $GITHUB_STEP_SUMMARY
          echo "**Test Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tested Components:**" >> $GITHUB_STEP_SUMMARY
          echo "- Config parsing" >> $GITHUB_STEP_SUMMARY
          echo "- Input validation logic" >> $GITHUB_STEP_SUMMARY
          echo "- Trait extraction logic" >> $GITHUB_STEP_SUMMARY
