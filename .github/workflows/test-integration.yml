name: Integration Tests

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'Dockerfile'
      - 'tests/integration/**'
      - '.github/workflows/test-integration.yml'
  pull_request:
    branches:
      - '**'
    paths:
      - 'scripts/**'
      - 'Dockerfile'
      - 'tests/integration/**'
      - '.github/workflows/test-integration.yml'
  workflow_dispatch:

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    name: Run Integration Tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: gapit3:test-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Make test script executable
        run: chmod +x tests/integration/test-env-vars-e2e.sh

      - name: Run integration tests
        run: |
          # Export test image tag for test script to use
          export TEST_IMAGE="gapit3:test-${{ github.sha }}"

          # Update test script to use our image tag
          sed -i "s/TEST_IMAGE=\"gapit3:test-\$(date +%s)\"/TEST_IMAGE=\"${TEST_IMAGE}\"/" tests/integration/test-env-vars-e2e.sh

          # Run integration tests
          bash tests/integration/test-env-vars-e2e.sh

      - name: Test Docker help command
        if: always()
        run: |
          docker run --rm gapit3:test-${{ github.sha }} help

      - name: Test Docker with custom env vars
        if: always()
        run: |
          docker run --rm \
            -e TRAIT_INDEX=3 \
            -e MODELS=BLINK \
            -e PCA_COMPONENTS=5 \
            gapit3:test-${{ github.sha }} help

      - name: Test invalid model validation
        if: always()
        run: |
          set +e
          output=$(docker run --rm \
            -e MODELS=INVALID \
            gapit3:test-${{ github.sha }} run-single-trait 2>&1)
          exit_code=$?

          if [ $exit_code -ne 1 ]; then
            echo "ERROR: Expected exit code 1, got $exit_code"
            exit 1
          fi

          if ! echo "$output" | grep -q "Invalid model"; then
            echo "ERROR: Expected 'Invalid model' in output"
            echo "Output: $output"
            exit 1
          fi

          echo "✓ Invalid model validation works correctly"

      - name: Test invalid PCA validation
        if: always()
        run: |
          set +e
          output=$(docker run --rm \
            -e PCA_COMPONENTS=100 \
            gapit3:test-${{ github.sha }} run-single-trait 2>&1)
          exit_code=$?

          if [ $exit_code -ne 1 ]; then
            echo "ERROR: Expected exit code 1, got $exit_code"
            exit 1
          fi

          if ! echo "$output" | grep -q "between 0 and 20"; then
            echo "ERROR: Expected PCA range error in output"
            echo "Output: $output"
            exit 1
          fi

          echo "✓ Invalid PCA validation works correctly"

      - name: Test summary
        if: always()
        run: |
          echo "### Integration Tests Summary :whale:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image:** gapit3:test-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tested Components:**" >> $GITHUB_STEP_SUMMARY
          echo "- Environment variable passing to container" >> $GITHUB_STEP_SUMMARY
          echo "- Entrypoint validation logic" >> $GITHUB_STEP_SUMMARY
          echo "- Command routing (help, run-single-trait)" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid configuration detection" >> $GITHUB_STEP_SUMMARY
          echo "- Error message quality" >> $GITHUB_STEP_SUMMARY
          echo "- Fast failure on validation errors" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup Docker images
        if: always()
        run: |
          docker rmi gapit3:test-${{ github.sha }} || true
